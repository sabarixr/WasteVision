<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Dashboard ‚Äî Waste Reporter</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <style>
      :root {
        --primary: #10b981;
        --primary-dark: #059669;
        --secondary: #0ea5a4;
        --bg: #f9fafb;
        --surface: #ffffff;
        --border: #e5e7eb;
        --text: #1f2937;
        --text-muted: #6b7280;
        --radius: 12px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        --maxw: 900px;
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        margin: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
        background: linear-gradient(
          135deg,
          #f0fdf4 0%,
          #f9fafb 50%,
          #f0f9ff 100%
        );
        color: var(--text);
        display: flex;
        justify-content: center;
        padding: 20px;
      }

      .container {
        width: 100%;
        max-width: var(--maxw);
      }

      /* HEADER */
      .header {
        text-align: center;
        margin-bottom: 32px;
      }

      .logo {
        width: 60px;
        height: 60px;
        border-radius: 14px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 800;
        font-size: 26px;
        margin: 0 auto 16px auto;
        box-shadow: var(--shadow-lg);
      }

      .title {
        font-size: 28px;
        font-weight: 700;
        margin: 0;
      }

      .subtitle {
        font-size: 14px;
        color: var(--text-muted);
        margin-top: 6px;
      }

      .top-links {
        text-align: center;
        margin-top: 10px;
        margin-bottom: 24px;
      }

      .top-links a {
        font-weight: 600;
        color: var(--primary);
        text-decoration: none;
        padding: 6px 12px;
        border-radius: 8px;
        transition: 0.2s;
      }

      .top-links a:hover {
        background: rgba(16, 185, 129, 0.1);
      }

      /* STATS CARDS */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }

      .stat-card {
        background: var(--surface);
        padding: 20px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        text-align: center;
        transition: 0.2s;
      }

      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      .stat-number {
        font-size: 32px;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 8px;
      }

      .stat-label {
        font-size: 14px;
        color: var(--text-muted);
        font-weight: 500;
      }

      .stat-card.urgent .stat-number {
        color: #dc2626;
      }
      .stat-card.pending .stat-number {
        color: #f59e0b;
      }
      .stat-card.resolved .stat-number {
        color: #10b981;
      }

      /* FILTERS */
      .filters {
        background: var(--surface);
        padding: 20px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        margin-bottom: 20px;
      }

      .filter-row {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        align-items: center;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .filter-group label {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .filter-group select,
      .filter-group input {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 14px;
        background: white;
      }

      .filter-group select:focus,
      .filter-group input:focus {
        outline: none;
        border-color: var(--primary);
      }

      /* CARD */
      .card {
        background: var(--surface);
        padding: 32px;
        border-radius: var(--radius);
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--border);
        margin-bottom: 20px;
      }

      .card-title {
        font-size: 20px;
        font-weight: 600;
        margin: 0 0 20px 0;
        border-bottom: 1px solid var(--border);
        padding-bottom: 14px;
      }

      /* REPORT ITEM */
      .report-item {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 18px;
        margin-bottom: 16px;
        transition: 0.2s;
        background: white;
      }

      .report-item:hover {
        border-color: var(--primary);
        background: #f0fdf4;
      }

      .report-grid {
        display: grid;
        grid-template-columns: 180px 1fr;
        gap: 20px;
      }

      .report-img {
        width: 100%;
        height: 130px;
        object-fit: cover;
        border-radius: 10px;
        border: 1px solid var(--border);
      }

      .section-title {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
        color: var(--text-muted);
      }

      .value {
        font-size: 14px;
        font-weight: 500;
        color: var(--text);
      }

      .badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
      }

      .yes {
        background: #d1fae5;
        color: #065f46;
      }
      .no {
        background: #fee2e2;
        color: #7f1d1d;
      }

      /* ACTIONS */
      .actions {
        margin-top: 12px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 10px 14px;
        border-radius: 8px;
        border: none;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }
      .btn-primary:hover {
        background: var(--primary-dark);
      }

      .btn-danger {
        background: #dc2626;
        color: white;
      }
      .btn-danger:hover {
        background: #b91c1c;
      }

      .btn-note {
        background: #f3f4f6;
        color: var(--text);
        border: 1px solid var(--border);
      }

      .btn-note:hover {
        background: #e5e7eb;
      }

      .empty {
        text-align: center;
        padding: 40px 16px;
        color: var(--text-muted);
        font-size: 14px;
      }

      @media (max-width: 700px) {
        .report-grid {
          grid-template-columns: 1fr;
        }
        .card {
          padding: 20px;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="header">
        <div class="logo">üåç</div>
        <h1 class="title">Reports Dashboard</h1>
        <p class="subtitle">Manage waste reports submitted by citizens</p>
      </div>

      <div class="top-links">
        <a href="/static/upload.html">New Report</a>
        &nbsp;&nbsp;‚Ä¢&nbsp;&nbsp;
        <a href="/">Home</a>
      </div>

      <!-- Stats Cards -->
      <div id="stats-container"></div>

      <!-- Filters -->
      <div class="filters">
        <div class="filter-row">
          <div class="filter-group">
            <label>Status</label>
            <select id="filter-status">
              <option value="all">All</option>
              <option value="pending">AI Review Pending</option>
              <option value="urgent">AI: Urgent</option>
              <option value="resolved">Resolved</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Sort By</label>
            <select id="filter-sort">
              <option value="newest">Newest First</option>
              <option value="oldest">Oldest First</option>
              <option value="location">By Location</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Search</label>
            <input
              type="text"
              id="filter-search"
              placeholder="Search in notes..."
            />
          </div>
        </div>
      </div>

      <div class="card">
        <h2 class="card-title">All Reports</h2>
        <div id="list"></div>
      </div>
    </div>

    <script>
      const token = localStorage.getItem("token");
      if (!token) {
        alert("Please login");
        location.href = "/static/login.html";
      }

      let currentUser = null;
      let allReports = []; // Store all reports for filtering

      async function getCurrentUser() {
        const res = await fetch("/api/me", {
          headers: { Authorization: "Bearer " + token },
        });
        if (res.status === 401) {
          alert("Session expired");
          localStorage.removeItem("token");
          location.href = "/static/login.html";
          return null;
        }
        return await res.json();
      }

      async function loadStats() {
        const res = await fetch("/api/analytics/stats", {
          headers: { Authorization: "Bearer " + token },
        });

        if (res.status === 401) {
          alert("Session expired");
          localStorage.removeItem("token");
          location.href = "/static/login.html";
          return;
        }

        const stats = await res.json();
        const statsContainer = document.getElementById("stats-container");

        if (stats.role === "authority") {
          statsContainer.innerHTML = `
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number">${stats.total_reports}</div>
          <div class="stat-label">Total Reports</div>
        </div>
        <div class="stat-card pending">
          <div class="stat-number">${stats.pending_reports}</div>
          <div class="stat-label">AI Review Pending</div>
        </div>
        <div class="stat-card urgent">
          <div class="stat-number">${stats.urgent_reports}</div>
          <div class="stat-label">AI: Urgent Cases</div>
        </div>
        <div class="stat-card resolved">
          <div class="stat-number">${stats.resolved_reports}</div>
          <div class="stat-label">Resolved</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${stats.active_citizens}</div>
          <div class="stat-label">Active Citizens</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${stats.recent_reports}</div>
          <div class="stat-label">This Week</div>
        </div>
      </div>
    `;
        } else {
          statsContainer.innerHTML = `
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number">${stats.total_reports}</div>
          <div class="stat-label">My Reports</div>
        </div>
        <div class="stat-card pending">
          <div class="stat-number">${stats.pending_reports}</div>
          <div class="stat-label">AI Review Pending</div>
        </div>
        <div class="stat-card urgent">
          <div class="stat-number">${stats.urgent_reports}</div>
          <div class="stat-label">AI: Urgent</div>
        </div>
        <div class="stat-card resolved">
          <div class="stat-number">${stats.resolved_reports}</div>
          <div class="stat-label">Resolved</div>
        </div>
      </div>
    `;
        }
      }

      function getStatusText(report) {
        if (report.immediate_attention === null) return "pending";
        if (report.immediate_attention === true) return "urgent";
        return "resolved";
      }

      function getStatusBadgeClass(report) {
        if (report.immediate_attention === null) return "badge";
        return report.immediate_attention ? "badge yes" : "badge no";
      }

      function getStatusBadgeText(report) {
        if (report.immediate_attention === null) return "AI Review Pending";
        return report.immediate_attention ? "AI: Urgent" : "Resolved";
      }

      function filterAndSortReports() {
        const statusFilter = document.getElementById("filter-status").value;
        const sortFilter = document.getElementById("filter-sort").value;
        const searchFilter = document
          .getElementById("filter-search")
          .value.toLowerCase();

        let filtered = allReports.filter((r) => {
          // Status filter
          const status = getStatusText(r);
          if (statusFilter !== "all" && status !== statusFilter) return false;

          // Search filter
          if (searchFilter && !r.notes?.toLowerCase().includes(searchFilter))
            return false;

          return true;
        });

        // Sort
        if (sortFilter === "newest") {
          filtered.sort(
            (a, b) => new Date(b.created_at) - new Date(a.created_at)
          );
        } else if (sortFilter === "oldest") {
          filtered.sort(
            (a, b) => new Date(a.created_at) - new Date(b.created_at)
          );
        } else if (sortFilter === "location") {
          filtered.sort((a, b) => {
            const aLat = a.lat || 0;
            const bLat = b.lat || 0;
            return aLat - bLat;
          });
        }

        renderReports(filtered);
      }

      function renderReports(reports) {
        const list = document.getElementById("list");
        list.innerHTML = "";

        if (reports.length === 0) {
          list.innerHTML = `<div class="empty">No reports match your filters.</div>`;
          return;
        }

        reports.forEach((r) => {
          const el = document.createElement("div");
          el.className = "report-item";

          // Only show action buttons for authority users
          const actionsHtml =
            currentUser && currentUser.role === "authority"
              ? `
      <div class="actions">
        <button class="btn btn-primary" onclick="mark(${r.id}, true)">Override as Urgent</button>
        <button class="btn btn-danger" onclick="mark(${r.id}, false)">Mark Resolved</button>
        <button class="btn btn-note" onclick="addNote(${r.id})">Add Note</button>
      </div>
    `
              : "";

          const reportDate = new Date(r.created_at).toLocaleDateString();

          el.innerHTML = `
      <div class="report-grid">
        ${
          r.image_url
            ? `<img class="report-img" src="${r.image_url}">`
            : `<div class="report-img" style="background:#f3f4f6;display:flex;align-items:center;justify-content:center;color:#9ca3af;">No Image</div>`
        }

        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div>
              <div class="section-title">Report #${r.id}</div>
              <div class="value">by User ${r.uploader_id} ‚Ä¢ ${reportDate}</div>
            </div>
            <span class="${getStatusBadgeClass(r)}">
              ${getStatusBadgeText(r)}
            </span>
          </div>

          <div style="margin-bottom: 10px;">
            <div class="section-title">Location</div>
            <div class="value">${r.lat?.toFixed(4) || "Not specified"}, ${
            r.lon?.toFixed(4) || "Not specified"
          }</div>
          </div>

          <div style="margin-bottom: 10px;">
            <div class="section-title">Notes</div>
            <div class="value">${r.notes || "No additional notes"}</div>
          </div>

          ${actionsHtml}

        </div>
      </div>
    `;

          list.appendChild(el);
        });
      }

      async function load() {
        currentUser = await getCurrentUser();
        if (!currentUser) return;

        // Load stats first
        await loadStats();

        // Adjust UI based on role
        const title = document.querySelector(".title");
        const subtitle = document.querySelector(".subtitle");
        const topLinks = document.querySelector(".top-links");
        const cardTitle = document.querySelector(".card-title");

        if (currentUser.role === "authority") {
          title.textContent = "Authority Dashboard";
          subtitle.textContent = "Monitor and manage all citizen reports";
          cardTitle.textContent = "All Reports";
          // Authority shouldn't create new reports
          topLinks.innerHTML = `<a href="/">Home</a> &nbsp;&nbsp;‚Ä¢&nbsp;&nbsp; <a href="#" onclick="location.reload()">Refresh</a>`;
        } else {
          title.textContent = "My Reports Dashboard";
          subtitle.textContent =
            "Track your submitted reports and create new ones";
          cardTitle.textContent = "My Reports";
          // Citizens can create new reports
          topLinks.innerHTML = `<a href="/static/upload.html">üìù New Report</a> &nbsp;&nbsp;‚Ä¢&nbsp;&nbsp; <a href="/">üè† Home</a> &nbsp;&nbsp;‚Ä¢&nbsp;&nbsp; <a href="#" onclick="location.reload()">üîÑ Refresh</a>`;
        }

        // Load reports
        const res = await fetch("/api/reports", {
          headers: { Authorization: "Bearer " + token },
        });

        if (res.status === 401) {
          alert("Session expired");
          localStorage.removeItem("token");
          location.href = "/static/login.html";
          return;
        }

        allReports = await res.json();

        // Set up filter event listeners
        document
          .getElementById("filter-status")
          .addEventListener("change", filterAndSortReports);
        document
          .getElementById("filter-sort")
          .addEventListener("change", filterAndSortReports);
        document
          .getElementById("filter-search")
          .addEventListener("input", filterAndSortReports);

        // Initial render
        filterAndSortReports();
      }

      async function mark(id, val) {
        await fetch(`/api/reports/${id}/action`, {
          method: "POST",
          headers: {
            Authorization: "Bearer " + token,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ immediate_attention: val }),
        });

        // Reload data to refresh stats and reports
        load();
      }

      async function addNote(id) {
        const note = prompt("Enter note:");
        if (!note) return;
        await fetch(`/api/reports/${id}/action`, {
          method: "POST",
          headers: {
            Authorization: "Bearer " + token,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ notes: note }),
        });

        // Reload data to refresh stats and reports
        load();
      }

      load();
    </script>
  </body>
</html>
